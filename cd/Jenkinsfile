pipeline {
  agent { label 'master' }  // æŒ‡å®šåœ¨ master ç¯€é»åŸ·è¡Œ

  environment {
    TZ = 'Asia/Taipei'
  }

  parameters {
    choice(name: 'PROJECT_NAME', choices: ['cclemon-auth', 'cclemon-health'])
    choice(name: 'PROFILE', choices: ['dev', 'prod'])
  }

  stages {
    stage('Deploy') {
      steps {
        dir("${params.PROJECT_NAME}") {
          script {
            def containerName = "${params.PROJECT_NAME}-${params.PROFILE}"
            def imageName = "${params.PROJECT_NAME}:${params.PROFILE}"

            echo "Deploying ${containerName} using image ${imageName}"

            sh """
              echo "ğŸ”„ åœæ­¢ä¸¦ç§»é™¤èˆŠå®¹å™¨ï¼ˆå¦‚æœæœ‰ï¼‰"
              docker rm -f ${containerName} || true

              echo "ğŸš€ å•Ÿå‹•æ–°å®¹å™¨"
              docker run -d \
                --name ${containerName} \
                --network cclemon-network \
                -e SPRING_PROFILES_ACTIVE=${params.PROFILE} \
                ${imageName}

              echo "ğŸ” ç¢ºèªå®¹å™¨æ˜¯å¦å•Ÿå‹•ä¸­..."

              for i in {1..10}; do
                STATUS=\$(docker inspect -f '{{.State.Running}}' ${containerName} 2>/dev/null || echo "false")
                if [ "\$STATUS" = "true" ]; then
                  echo "âœ… å®¹å™¨ ${containerName} å•Ÿå‹•æˆåŠŸ"
                  exit 0
                fi
                echo "âŒ› å®¹å™¨å°šæœªå•Ÿå‹•ï¼Œé‡è©¦ \$i..."
                sleep 2
              done

              echo "âŒ å®¹å™¨ ${containerName} å•Ÿå‹•å¤±æ•—ï¼Œåˆ—å‡º logsï¼š"
              docker logs ${containerName} || true
              exit 1
            """
          }
        }
      }
    }
  }
}
