pipeline {
  agent { label 'master' }  // æŒ‡å®šåœ¨ master ç¯€é»åŸ·è¡Œ

  environment {
    TZ = 'Asia/Taipei'
  }

  parameters {
    choice(name: 'PROJECT_NAME', choices: ['cclemon-auth', 'cclemon-health' ,'cclemon-config-server'])
    choice(name: 'PROFILE', choices: ['dev', 'prod'])
  }

  stages {
    stage('Deploy') {
      steps {
        dir("${params.PROJECT_NAME}") {
          script {
            def containerName = "${params.PROJECT_NAME}-${params.PROFILE}"
            def imageName = "${params.PROJECT_NAME}:${params.PROFILE}"

            echo "Deploying ${containerName} using image ${imageName}"

            sh """
              echo "ğŸ”„ åœæ­¢ä¸¦åˆªé™¤èˆŠå®¹å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰"
              docker rm -f ${containerName} || true

              echo "ğŸš€ å•Ÿå‹•æ–°å®¹å™¨"
              docker run -d \
                --name ${containerName} \
                --network cclemon-network \
                -e SPRING_PROFILES_ACTIVE=${params.PROFILE} \
                ${imageName}

              echo "âŒ› ç­‰å¾…æ‡‰ç”¨å¥åº·å•Ÿå‹•ä¸­..."

              MAX_RETRIES=20
              SLEEP_INTERVAL=3
              for i in \$(seq 1 \$MAX_RETRIES); do
                STATUS=\$(curl -s http://${containerName}/actuator/health | grep -o '"status":"UP"' || true)
                if [ "\$STATUS" = '"status":"UP"' ]; then
                  echo "âœ… å¥åº·æª¢æŸ¥é€šéï¼Œæ‡‰ç”¨å·²å•Ÿå‹•"
                  break
                else
                  echo "ğŸ•’ ç¬¬ \$i æ¬¡é‡è©¦ï¼Œæ‡‰ç”¨å°šæœªå°±ç·’ï¼Œç­‰å¾… \$SLEEP_INTERVAL ç§’..."
                  sleep \$SLEEP_INTERVAL
                fi
              done

              # æœ€çµ‚å†æª¢æŸ¥ä¸€æ¬¡
              FINAL=\$(curl -s http://localhost:${port}/actuator/health | grep -o '"status":"UP"' || true)
              if [ "\$FINAL" != '"status":"UP"' ]; then
                echo "âŒ æ‡‰ç”¨æœªæˆåŠŸå•Ÿå‹•ï¼Œè¼¸å‡ºæ—¥èªŒï¼š"
                docker logs ${containerName} || true
                exit 1
              fi
            """
          }
        }
      }
    }
  }
}
